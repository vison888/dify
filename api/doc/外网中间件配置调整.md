# 外网中间件配置调整说明

## 概述

为了使用部署在外网服务器 `101.126.80.22` 上的中间件服务，需要对 `sss.env` 配置文件进行相应的调整。本文档记录了所有需要修改的配置项以及相关的网络要求。

## 中间件服务列表

以下中间件服务已部署在外网服务器 `101.126.80.22` 上：

| 服务名称 | 端口 | 说明 |
|---------|------|------|
| PostgreSQL | 5432 | 主数据库服务 |
| Redis | 6379 | 缓存和消息队列服务 |
| Weaviate | 8080 | 向量数据库服务 |
| Plugin Daemon | 5002 | 插件守护进程服务 |
| Plugin Remote Install | 5003 | 插件远程安装服务 |
| Sandbox | 8194 | 代码执行沙箱服务 |
| SSRF Proxy | 3128 | SSRF 代理服务 |

## 配置文件调整详情

### 1. 数据库配置 (PostgreSQL)

**修改前：**
```env
DB_HOST=localhost
```

**修改后：**
```env
DB_HOST=101.126.80.22
```

### 2. Redis 配置

**修改前：**
```env
REDIS_HOST=localhost
CELERY_BROKER_URL=redis://:difyai123456@localhost:${REDIS_PORT}/1
```

**修改后：**
```env
REDIS_HOST=101.126.80.22
CELERY_BROKER_URL=redis://:difyai123456@101.126.80.22:${REDIS_PORT}/1
```

### 3. 向量数据库配置 (Weaviate)

**修改前：**
```env
WEAVIATE_ENDPOINT=http://localhost:8080
```

**修改后：**
```env
WEAVIATE_ENDPOINT=http://101.126.80.22:8080
```

### 4. 代码执行配置 (Sandbox)

**修改前：**
```env
CODE_EXECUTION_ENDPOINT=http://127.0.0.1:8194
```

**修改后：**
```env
CODE_EXECUTION_ENDPOINT=http://101.126.80.22:8194
```

### 5. 插件服务配置

**修改前：**
```env
PLUGIN_DAEMON_URL=http://127.0.0.1:5002
PLUGIN_REMOTE_INSTALL_HOST=localhost
```

**修改后：**
```env
PLUGIN_DAEMON_URL=http://101.126.80.22:5002
PLUGIN_REMOTE_INSTALL_HOST=101.126.80.22
```

### 6. 端点配置

**修改前：**
```env
ENDPOINT_URL_TEMPLATE=http://localhost:5002/e/{hook_id}
```

**修改后：**
```env
ENDPOINT_URL_TEMPLATE=http://101.126.80.22:5002/e/{hook_id}
```

## 网络要求

### 外网服务器 (101.126.80.22) 需要开放的端口

确保以下端口在服务器防火墙中已开放：

```bash
# 数据库端口
5432  # PostgreSQL

# 缓存和消息队列
6379  # Redis

# 向量数据库
8080  # Weaviate

# 插件服务
5002  # Plugin Daemon
5003  # Plugin Remote Install

# 代码执行
8194  # Sandbox

# 代理服务
3128  # SSRF Proxy
```

### 防火墙配置示例

如果使用 `ufw` 防火墙：

```bash
# 开放数据库端口
sudo ufw allow 5432/tcp

# 开放 Redis 端口
sudo ufw allow 6379/tcp

# 开放 Weaviate 端口
sudo ufw allow 8080/tcp

# 开放插件服务端口
sudo ufw allow 5002/tcp
sudo ufw allow 5003/tcp

# 开放代码执行端口
sudo ufw allow 8194/tcp

# 开放代理服务端口
sudo ufw allow 3128/tcp
```

如果使用 `iptables`：

```bash
# 开放端口
iptables -A INPUT -p tcp --dport 5432 -j ACCEPT
iptables -A INPUT -p tcp --dport 6379 -j ACCEPT
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
iptables -A INPUT -p tcp --dport 5002 -j ACCEPT
iptables -A INPUT -p tcp --dport 5003 -j ACCEPT
iptables -A INPUT -p tcp --dport 8194 -j ACCEPT
iptables -A INPUT -p tcp --dport 3128 -j ACCEPT

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

## 注意事项

1. **安全性考虑**：确保这些端口只对授权的 IP 地址开放，避免暴露给整个互联网。

2. **网络延迟**：使用外网中间件可能会增加网络延迟，建议监控应用性能。

3. **连接稳定性**：确保网络连接稳定，考虑实施连接重试和超时机制。

4. **数据安全**：确保所有中间件服务都配置了适当的认证和加密。

5. **监控告警**：建议对所有中间件服务设置监控和告警机制。

## 验证配置

配置完成后，可以通过以下方式验证连接：

```bash
# 测试 PostgreSQL 连接
pg_isready -h 101.126.80.22 -p 5432

# 测试 Redis 连接
redis-cli -h 101.126.80.22 -p 6379 -a difyai123456 ping

# 测试 Weaviate 连接
curl http://101.126.80.22:8080/v1/.well-known/ready

# 测试插件服务连接
curl http://101.126.80.22:5002/health

# 测试代码执行服务连接
curl http://101.126.80.22:8194/health
```

## 回滚方案

如果需要回滚到本地中间件，将以上配置中的 `101.126.80.22` 改回 `localhost` 或 `127.0.0.1` 即可。

---

**文档创建时间：** 2025-01-14  
**最后更新时间：** 2025-01-14  
**版本：** v1.0