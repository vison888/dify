# Dify 数据库结构文档

## 文档概述

本目录包含了 Dify AI 应用开发平台的完整数据库设计文档，基于对 `models/` 目录下所有模型文件的详细分析。

## 文档结构

### 主要文档

- **[数据库表结构及关系.md](./数据库表结构及关系.md)** - 完整的数据库表结构设计文档
  - 包含所有 87 个数据库表的详细字段定义
  - 完整的实体关系图 (Mermaid)
  - 数据库设计特点分析

- **[表索引快速参考.md](./表索引快速参考.md)** - 按模块分类的表索引
  - 87 个表的功能分类和快速查找
  - 表统计和使用模式说明
  - 常用查询模式参考

- **[数据库关系图.md](./数据库关系图.md)** - 独立的数据库关系图
  - 完整的 Mermaid ER 图
  - 关系说明和使用指南
  - 支持在线查看和导出

## 数据库概览

### 表统计
- **总表数量**: 87 个数据库表
- **核心模块**: 11 个功能模块
- **关系复杂度**: 高度关联的多租户架构

### 核心模块分类

| 模块 | 表数量 | 主要功能 |
|------|--------|----------|
| **账户与租户管理** | 7 | 用户认证、多租户隔离、权限控制 |
| **应用管理** | 15 | AI应用创建、配置、部署管理 |
| **数据集管理** | 12 | 知识库、文档处理、向量索引 |
| **工作流管理** | 4 | 可视化工作流编排与执行 |
| **模型提供商管理** | 6 | AI模型集成与配置管理 |
| **工具管理** | 8 | 内置工具、API工具、工作流工具 |
| **任务管理** | 2 | 异步任务处理 (Celery) |
| **Web相关** | 2 | 前端交互功能 |
| **数据源管理** | 2 | 外部数据源集成 |
| **扩展管理** | 1 | API扩展机制 |
| **其他** | 28 | 标签、API、日志等辅助功能 |

### 主要特性

#### 🏢 **多租户架构**
- 所有核心表都包含 `tenant_id` 字段
- 完整的租户级别数据隔离
- 灵活的权限控制机制

#### 🔧 **高度可配置**
- JSON/JSONB 字段存储复杂配置
- 支持多种应用模式和工具类型
- 动态配置更新机制

#### 🔒 **安全设计**
- 敏感数据加密存储
- 多层次的认证授权
- 完整的审计日志

#### 📈 **可扩展性**
- 插件化的工具系统
- 灵活的工作流引擎
- 支持多种AI模型提供商

## 快速导航

### 核心表索引

#### 👤 **用户与权限**
- `Account` - 用户账户
- `Tenant` - 租户管理
- `TenantAccountJoin` - 租户用户关联

#### 🚀 **应用核心**
- `App` - 应用主表
- `Conversation` - 会话管理
- `Message` - 消息记录

#### 📚 **知识管理**
- `Dataset` - 数据集
- `Document` - 文档管理
- `DocumentSegment` - 文档分段

#### ⚡ **工作流**
- `Workflow` - 工作流定义
- `WorkflowRun` - 工作流执行
- `WorkflowNodeExecutionModel` - 节点执行

#### 🤖 **AI集成**
- `Provider` - 模型提供商
- `ApiToolProvider` - API工具
- `BuiltinToolProvider` - 内置工具

## 数据库关系概览

```
租户 (Tenant)
├── 用户 (Account) - 多对多关系
├── 应用 (App)
│   ├── 会话 (Conversation)
│   │   └── 消息 (Message)
│   ├── 工作流 (Workflow)
│   │   └── 工作流运行 (WorkflowRun)
│   └── 数据集关联 (AppDatasetJoin)
├── 数据集 (Dataset)
│   ├── 文档 (Document)
│   │   └── 文档分段 (DocumentSegment)
│   └── 查询记录 (DatasetQuery)
├── 模型提供商 (Provider)
├── 工具提供商 (ApiToolProvider, BuiltinToolProvider)
└── 扩展 (APIBasedExtension)
```

## 技术特点

### 🗄️ **数据库技术栈**
- **主数据库**: PostgreSQL
- **ORM**: SQLAlchemy
- **UUID**: 统一使用 StringUUID 主键
- **JSON**: 大量使用 JSONB 存储配置

### 📊 **性能优化**
- 关键字段建立索引
- 分页查询支持
- 软删除机制
- 缓存友好设计

### 🔄 **数据一致性**
- 外键约束
- 唯一性约束
- 事务支持
- 审计字段

## 开发指南

### 🛠️ **模型文件结构**
```
models/
├── account.py          # 账户与租户
├── model.py           # 核心应用模型
├── dataset.py         # 数据集相关
├── workflow.py        # 工作流相关
├── provider.py        # 模型提供商
├── tools.py           # 工具管理
├── task.py            # 任务管理
├── web.py             # Web相关
├── source.py          # 数据源
├── api_based_extension.py  # API扩展
├── types.py           # 自定义类型
├── engine.py          # 数据库引擎
├── enums.py           # 枚举定义
└── base.py            # 基础模型
```

### 📝 **命名规范**
- **表名**: 小写下划线 (`user_accounts`)
- **字段名**: 小写下划线 (`created_at`)
- **外键**: `{table}_id` 格式
- **索引**: `{table}_{field}_idx` 格式

### 🔗 **关系类型**
- **一对一**: App ↔ Site
- **一对多**: App → Conversation
- **多对多**: App ↔ Dataset (通过 AppDatasetJoin)

## 版本信息

- **文档版本**: v1.0
- **创建时间**: 2025-01-14
- **基于代码**: Dify API v1.7.0
- **数据库**: PostgreSQL 15+

## 更新日志

### v1.0 (2025-01-14)
- 初始版本发布
- 完整的 87 个表结构文档
- 实体关系图 (Mermaid)
- 设计特点分析

---

**维护者**: Dify 开发团队  
**文档类型**: 技术文档  
**更新频率**: 跟随代码版本更新