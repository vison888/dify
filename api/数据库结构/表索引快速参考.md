# Dify 数据库表索引快速参考

## 表总览

本文档提供 Dify 数据库中所有 87 个表的快速索引，按功能模块分类。

---

## 1. 账户与租户管理 (7 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `accounts` | 用户账户管理 | id, name, email, status |
| `tenants` | 租户/工作空间管理 | id, name, plan, status |
| `tenant_account_joins` | 租户用户关联 | tenant_id, account_id, role |
| `account_integrates` | 第三方账户集成 | account_id, provider, open_id |
| `invitation_codes` | 邀请码管理 | code, status, batch |
| `account_plugin_permissions` | 租户插件权限 | tenant_id, install_permission |
| `tenant_plugin_auto_upgrade_strategies` | 插件自动升级策略 | tenant_id, strategy_setting |

---

## 2. 应用管理 (15 表)

### 核心应用表
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `apps` | AI应用主表 | id, tenant_id, name, mode |
| `app_model_configs` | 应用模型配置 | app_id, provider, model_id |
| `sites` | 应用站点配置 | app_id, title, code |

### 会话与消息
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `conversations` | 会话管理 | id, app_id, name, status |
| `messages` | 消息记录 | id, conversation_id, query, answer |
| `message_agent_thoughts` | AI代理思考过程 | message_id, thought, tool |
| `message_annotations` | 消息标注 | message_id, content, account_id |
| `message_chains` | 消息链 | id, message_id, type |
| `message_feedbacks` | 消息反馈 | message_id, rating, content |
| `message_files` | 消息附件 | message_id, url, type |

### 系统与用户
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `dify_setups` | 系统初始化 | version, setup_at |
| `end_users` | 终端用户 | id, tenant_id, session_id |
| `upload_files` | 文件上传 | id, name, size, key |
| `recommended_apps` | 推荐应用 | app_id, language, category |
| `installed_apps` | 已安装应用 | tenant_id, app_id, is_pinned |

---

## 3. 数据集管理 (12 表)

### 核心数据集表
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `datasets` | 数据集主表 | id, tenant_id, name, indexing_technique |
| `documents` | 文档管理 | id, dataset_id, name, indexing_status |
| `document_segments` | 文档分段 | id, document_id, content, tokens |

### 数据集功能表
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `app_dataset_joins` | 应用数据集关联 | app_id, dataset_id |
| `dataset_permissions` | 数据集权限 | dataset_id, account_id |
| `dataset_process_rules` | 数据处理规则 | dataset_id, mode, rules |
| `dataset_queries` | 数据集查询记录 | dataset_id, content, source |
| `dataset_keyword_tables` | 关键词表 | dataset_id, keyword_table |
| `dataset_collection_bindings` | 集合绑定 | provider_name, collection_name |

### 向量与外部知识
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `embeddings` | 向量嵌入 | hash, embedding |
| `external_knowledge_apis` | 外部知识API | name, settings |
| `external_knowledge_bindings` | 外部知识绑定 | dataset_id, external_knowledge_id |

---

## 4. 工作流管理 (4 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `workflows` | 工作流定义 | id, app_id, type, graph |
| `workflow_runs` | 工作流运行实例 | id, workflow_id, status, inputs |
| `workflow_node_executions` | 节点执行记录 | workflow_run_id, node_id, status |
| `workflow_app_logs` | 工作流应用日志 | app_id, workflow_id, created_from |
| `conversation_variables` | 会话变量 | app_id, conversation_id, variable |

---

## 5. 模型提供商管理 (6 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `providers` | 模型提供商 | id, tenant_id, provider_name, is_valid |
| `provider_models` | 提供商模型 | tenant_id, provider_name, model_name |
| `provider_model_settings` | 模型设置 | provider_name, model_name, model_type |
| `provider_orders` | 提供商顺序 | tenant_id, provider_name, sort_order |
| `tenant_default_models` | 租户默认模型 | tenant_id, model_type, provider_name |
| `tenant_preferred_model_providers` | 租户首选提供商 | tenant_id, provider_name |
| `load_balancing_model_configs` | 负载均衡配置 | tenant_id, provider_name, model_name |

---

## 6. 工具管理 (8 表)

### 工具提供商
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `tool_api_providers` | API工具提供商 | id, name, schema, tools_str |
| `tool_builtin_providers` | 内置工具提供商 | id, tenant_id, provider, encrypted_credentials |
| `tool_workflow_providers` | 工作流工具提供商 | id, app_id, name, parameter_configuration |

### 工具功能表
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `tool_conversation_variables` | 工具会话变量 | conversation_id, variables_str |
| `tool_files` | 工具文件 | id, user_id, tool_file_id |
| `tool_label_bindings` | 工具标签绑定 | tool_id, tool_type, label_name |
| `tool_model_invokes` | 工具模型调用 | id, user_id, tool_type, model_provider |

### OAuth支持
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `tool_oauth_system_clients` | 系统级OAuth客户端 | plugin_id, provider |
| `tool_oauth_tenant_clients` | 租户级OAuth客户端 | tenant_id, plugin_id, provider |

---

## 7. 任务管理 (2 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `celery_taskmeta` | Celery任务元数据 | task_id, status, result |
| `celery_tasksetmeta` | Celery任务集元数据 | taskset_id, result |

---

## 8. Web相关 (2 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `saved_messages` | 保存的消息 | app_id, message_id, created_by |
| `pinned_conversations` | 置顶会话 | app_id, conversation_id, created_by |

---

## 9. 数据源管理 (2 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `data_source_oauth_bindings` | OAuth数据源绑定 | tenant_id, provider, access_token |
| `data_source_api_key_auth_bindings` | API密钥数据源绑定 | tenant_id, provider, credentials |

---

## 10. 扩展管理 (1 表)

| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `api_based_extensions` | API扩展 | tenant_id, name, api_endpoint |

---

## 11. 其他支持表 (28 表)

### API与认证
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `api_requests` | API请求日志 | tenant_id, path, ip |
| `api_tokens` | API令牌 | app_id, token, type |

### 标签系统
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `tags` | 标签管理 | tenant_id, type, name |
| `tag_bindings` | 标签绑定 | tag_id, target_id |

### 其他功能表
| 表名 | 主要功能 | 关键字段 |
|------|----------|----------|
| `operation_logs` | 操作日志 | tenant_id, account_id, action |
| `trace_app_configs` | 应用追踪配置 | app_id, tracing_provider |
| `dataset_retriever_resources` | 数据集检索资源 | message_id, position, dataset_id |
| `app_annotation_settings` | 应用标注设置 | app_id, score_threshold |
| `app_annotation_hit_histories` | 标注命中历史 | app_id, annotation_id, source |
| `tidb_auth_bindings` | TiDB认证绑定 | user_id, api_url, cluster_id |
| `whitelists` | 白名单 | tenant_id, target_id, target_type |

---

## 索引统计

### 按表数量分组
- **10+ 字段表**: 15 个 (复杂业务表)
- **5-10 字段表**: 42 个 (标准业务表)  
- **<5 字段表**: 30 个 (关联表和简单表)

### 按功能重要性
- **🔴 核心表 (18个)**: 应用、会话、消息、数据集、工作流等
- **🟡 重要表 (35个)**: 用户管理、工具、提供商等
- **🟢 辅助表 (34个)**: 日志、配置、关联表等

### 常用查询模式
- **租户隔离**: WHERE tenant_id = ?
- **应用范围**: WHERE app_id = ?  
- **时间范围**: WHERE created_at BETWEEN ? AND ?
- **状态过滤**: WHERE status = 'active'
- **软删除**: WHERE enabled = true AND archived = false

---

**说明**: 本文档提供快速查找表格的索引，详细的字段定义请参考 [数据库表结构及关系.md](./数据库表结构及关系.md)。