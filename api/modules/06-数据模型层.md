# 数据模型层 (models/)

## 概述

数据模型层定义了Dify API的所有数据实体和数据库表结构。采用SQLAlchemy ORM框架，支持多种数据库后端，实现了完整的数据持久化方案。

## 目录结构

```
models/
├── __init__.py                    # 模型模块初始化
├── account.py                     # 账户相关模型
├── api_based_extension.py         # API扩展模型
├── dataset.py                     # 数据集模型
├── engine.py                      # 数据库引擎
├── enums.py                       # 枚举定义
├── model.py                       # 核心业务模型
├── provider.py                    # 提供商模型
├── source.py                      # 数据源模型
├── task.py                        # 任务模型
├── tools.py                       # 工具模型
├── web.py                         # Web相关模型
└── workflow.py                    # 工作流模型
```

## 详细分析

### 1. account.py - 账户相关模型

**职责**: 定义用户账户、租户、权限等相关的数据模型。

**核心模型**:

#### 1.1 Account - 用户账户
```python
class Account(Base):
    __tablename__ = 'accounts'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    email = Column(String(255), unique=True, nullable=False, index=True)
    name = Column(String(255), nullable=False)
    password = Column(String(255), nullable=False)
    avatar = Column(String(255))
    status = Column(Enum(AccountStatus), default=AccountStatus.ACTIVE)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**字段说明**:
- `id`: 用户唯一标识
- `email`: 邮箱地址，唯一索引
- `name`: 用户姓名
- `password`: 加密密码
- `avatar`: 头像URL
- `status`: 账户状态
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### 1.2 Tenant - 租户
```python
class Tenant(Base):
    __tablename__ = 'tenants'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    plan = Column(String(50), default='free')
    status = Column(Enum(TenantStatus), default=TenantStatus.ACTIVE)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 1.3 TenantAccountJoin - 租户账户关联
```python
class TenantAccountJoin(Base):
    __tablename__ = 'tenant_account_joins'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    tenant_id = Column(StringUUID, ForeignKey('tenants.id'), nullable=False)
    account_id = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    role = Column(Enum(TenantAccountRole), default=TenantAccountRole.MEMBER)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 2. dataset.py - 数据集模型

**职责**: 定义数据集、文档、索引等相关的数据模型。

**核心模型**:

#### 2.1 Dataset - 数据集
```python
class Dataset(Base):
    __tablename__ = 'datasets'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    provider = Column(String(50), nullable=False)
    permission = Column(Enum(DatasetPermissionEnum), default=DatasetPermissionEnum.ALL_MEMBERS)
    embedding_model = Column(String(255), nullable=False)
    embedding_model_provider = Column(String(255), nullable=False)
    created_by = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 2.2 Document - 文档
```python
class Document(Base):
    __tablename__ = 'documents'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    dataset_id = Column(StringUUID, ForeignKey('datasets.id'), nullable=False)
    name = Column(String(255), nullable=False)
    doc_type = Column(String(50), nullable=False)
    doc_file = Column(String(255))
    doc_content = Column(Text)
    doc_metadata = Column(JSON)
    created_by = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 2.3 DocumentSegment - 文档片段
```python
class DocumentSegment(Base):
    __tablename__ = 'document_segments'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    document_id = Column(StringUUID, ForeignKey('documents.id'), nullable=False)
    content = Column(Text, nullable=False)
    embedding = Column(JSON)
    segment_hash = Column(String(255), index=True)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 3. model.py - 核心业务模型

**职责**: 定义应用、对话、消息等核心业务数据模型。

**核心模型**:

#### 3.1 App - 应用
```python
class App(Base):
    __tablename__ = 'apps'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    mode = Column(Enum(AppMode), nullable=False)
    icon_type = Column(Enum(IconType), default=IconType.EMOJI)
    icon = Column(String(255))
    color = Column(String(255))
    model_config = Column(JSON)
    created_by = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**应用模式**:
- `CHAT`: 对话模式
- `COMPLETION`: 补全模式
- `WORKFLOW`: 工作流模式
- `AGENT_CHAT`: 智能体对话模式

#### 3.2 Conversation - 对话
```python
class Conversation(Base):
    __tablename__ = 'conversations'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    app_id = Column(StringUUID, ForeignKey('apps.id'), nullable=False)
    user_id = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    name = Column(String(255))
    inputs = Column(JSON)
    status = Column(String(50), default='normal')
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 3.3 Message - 消息
```python
class Message(Base):
    __tablename__ = 'messages'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    conversation_id = Column(StringUUID, ForeignKey('conversations.id'), nullable=False)
    role = Column(String(50), nullable=False)  # user, assistant, system
    content = Column(Text, nullable=False)
    message_tokens = Column(Integer, default=0)
    answer = Column(Text)
    answer_tokens = Column(Integer, default=0)
    feedback = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 3.4 AppModelConfig - 应用模型配置
```python
class AppModelConfig(Base):
    __tablename__ = 'app_model_configs'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    app_id = Column(StringUUID, ForeignKey('apps.id'), nullable=False)
    provider = Column(String(255), nullable=False)
    model_id = Column(String(255), nullable=False)
    configs = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### 4. provider.py - 提供商模型

**职责**: 定义AI模型提供商相关的数据模型。

**核心模型**:

#### 4.1 Provider - 提供商
```python
class Provider(Base):
    __tablename__ = 'providers'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    tenant_id = Column(StringUUID, ForeignKey('tenants.id'), nullable=False)
    provider_name = Column(String(255), nullable=False)
    provider_type = Column(Enum(ProviderType), nullable=False)
    is_valid = Column(Boolean, default=True)
    credentials = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 4.2 ProviderModel - 提供商模型
```python
class ProviderModel(Base):
    __tablename__ = 'provider_models'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    provider_id = Column(StringUUID, ForeignKey('providers.id'), nullable=False)
    model_name = Column(String(255), nullable=False)
    model_type = Column(String(50), nullable=False)
    features = Column(JSON)
    model_properties = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### 5. workflow.py - 工作流模型

**职责**: 定义工作流相关的数据模型。

**核心模型**:

#### 5.1 Workflow - 工作流
```python
class Workflow(Base):
    __tablename__ = 'workflows'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    app_id = Column(StringUUID, ForeignKey('apps.id'), nullable=False)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    workflow_type = Column(Enum(WorkflowType), nullable=False)
    nodes = Column(JSON, nullable=False)
    edges = Column(JSON, nullable=False)
    variables = Column(JSON)
    created_by = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 5.2 WorkflowRun - 工作流运行
```python
class WorkflowRun(Base):
    __tablename__ = 'workflow_runs'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    workflow_id = Column(StringUUID, ForeignKey('workflows.id'), nullable=False)
    conversation_id = Column(StringUUID, ForeignKey('conversations.id'))
    inputs = Column(JSON)
    outputs = Column(JSON)
    status = Column(String(50), default='running')
    error = Column(Text)
    started_at = Column(DateTime, default=datetime.utcnow)
    finished_at = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
```

#### 5.3 WorkflowNodeExecutionModel - 工作流节点执行
```python
class WorkflowNodeExecutionModel(Base):
    __tablename__ = 'workflow_node_executions'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    workflow_run_id = Column(StringUUID, ForeignKey('workflow_runs.id'), nullable=False)
    node_id = Column(String(255), nullable=False)
    node_type = Column(String(50), nullable=False)
    inputs = Column(JSON)
    outputs = Column(JSON)
    status = Column(String(50), default='running')
    error = Column(Text)
    started_at = Column(DateTime, default=datetime.utcnow)
    finished_at = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 6. tools.py - 工具模型

**职责**: 定义工具相关的数据模型。

**核心模型**:

#### 6.1 ApiToolProvider - API工具提供商
```python
class ApiToolProvider(Base):
    __tablename__ = 'api_tool_providers'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    tenant_id = Column(StringUUID, ForeignKey('tenants.id'), nullable=False)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    api_endpoint = Column(String(255), nullable=False)
    api_method = Column(String(10), nullable=False)
    api_headers = Column(JSON)
    api_body = Column(JSON)
    created_by = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 6.2 BuiltinToolProvider - 内置工具提供商
```python
class BuiltinToolProvider(Base):
    __tablename__ = 'builtin_tool_providers'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    tenant_id = Column(StringUUID, ForeignKey('tenants.id'), nullable=False)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    tool_name = Column(String(255), nullable=False)
    tool_config = Column(JSON)
    created_by = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### 7. web.py - Web相关模型

**职责**: 定义Web前端相关的数据模型。

**核心模型**:

#### 7.1 PinnedConversation - 置顶对话
```python
class PinnedConversation(Base):
    __tablename__ = 'pinned_conversations'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    conversation_id = Column(StringUUID, ForeignKey('conversations.id'), nullable=False)
    user_id = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
```

#### 7.2 SavedMessage - 保存的消息
```python
class SavedMessage(Base):
    __tablename__ = 'saved_messages'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    message_id = Column(StringUUID, ForeignKey('messages.id'), nullable=False)
    user_id = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 8. enums.py - 枚举定义

**职责**: 定义系统中使用的各种枚举类型。

**核心枚举**:

#### 8.1 AccountStatus - 账户状态
```python
class AccountStatus(Enum):
    ACTIVE = 'active'
    INACTIVE = 'inactive'
    SUSPENDED = 'suspended'
    DELETED = 'deleted'
```

#### 8.2 AppMode - 应用模式
```python
class AppMode(Enum):
    CHAT = 'chat'
    COMPLETION = 'completion'
    WORKFLOW = 'workflow'
    AGENT_CHAT = 'agent-chat'
    ADVANCED_CHAT = 'advanced-chat'
```

#### 8.3 ProviderType - 提供商类型
```python
class ProviderType(Enum):
    OPENAI = 'openai'
    ANTHROPIC = 'anthropic'
    AZURE_OPENAI = 'azure_openai'
    GOOGLE = 'google'
    CUSTOM = 'custom'
```

#### 8.4 WorkflowType - 工作流类型
```python
class WorkflowType(Enum):
    BASIC = 'basic'
    ADVANCED = 'advanced'
    CUSTOM = 'custom'
```

### 9. engine.py - 数据库引擎

**职责**: 配置和管理数据库连接。

**核心配置**:
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, scoped_session

# 数据库引擎配置
engine = create_engine(
    DATABASE_URL,
    pool_size=10,
    max_overflow=20,
    pool_pre_ping=True,
    pool_recycle=3600
)

# 会话工厂
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
db = scoped_session(SessionLocal)
```

## 数据库设计原则

### 1. 规范化设计
- 遵循第三范式
- 避免数据冗余
- 保持数据一致性

### 2. 索引优化
- 主键索引
- 外键索引
- 查询字段索引
- 复合索引

### 3. 数据类型选择
- 使用合适的数据类型
- 考虑存储空间
- 考虑查询性能

### 4. 约束设计
- 主键约束
- 外键约束
- 唯一约束
- 非空约束

## 关系设计

### 1. 一对多关系
```python
# 租户 -> 应用
class App(Base):
    tenant_id = Column(StringUUID, ForeignKey('tenants.id'), nullable=False)
    tenant = relationship('Tenant', back_populates='apps')

class Tenant(Base):
    apps = relationship('App', back_populates='tenant')
```

### 2. 多对多关系
```python
# 租户 <-> 账户 (通过中间表)
class TenantAccountJoin(Base):
    tenant_id = Column(StringUUID, ForeignKey('tenants.id'), nullable=False)
    account_id = Column(StringUUID, ForeignKey('accounts.id'), nullable=False)
    
    tenant = relationship('Tenant', back_populates='account_joins')
    account = relationship('Account', back_populates='tenant_joins')
```

### 3. 继承关系
```python
# 工具提供商继承
class ToolProvider(Base):
    __tablename__ = 'tool_providers'
    
    id = Column(StringUUID, primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    provider_type = Column(String(50), nullable=False)
    
    __mapper_args__ = {
        'polymorphic_identity': 'tool_provider',
        'polymorphic_on': provider_type
    }

class ApiToolProvider(ToolProvider):
    __tablename__ = 'api_tool_providers'
    
    id = Column(StringUUID, ForeignKey('tool_providers.id'), primary_key=True)
    api_endpoint = Column(String(255), nullable=False)
    
    __mapper_args__ = {
        'polymorphic_identity': 'api_tool_provider',
    }
```

## 数据迁移

### 1. Alembic配置
```python
# alembic.ini
[alembic]
script_location = migrations
sqlalchemy.url = postgresql://user:pass@localhost/dify
```

### 2. 迁移脚本
```python
# 创建迁移
alembic revision --autogenerate -m "Add new table"

# 执行迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

## 性能优化

### 1. 查询优化
- 使用合适的索引
- 避免N+1查询
- 使用延迟加载
- 批量操作

### 2. 连接池管理
- 连接池大小配置
- 连接超时设置
- 连接回收策略

### 3. 缓存策略
- 查询结果缓存
- 对象缓存
- 缓存失效策略

## 数据安全

### 1. 数据加密
- 敏感字段加密
- 传输加密
- 存储加密

### 2. 访问控制
- 行级权限控制
- 列级权限控制
- 数据脱敏

### 3. 审计日志
- 数据变更日志
- 访问日志
- 操作审计

---

*本文档详细描述了Dify API数据模型层的架构和实现* 